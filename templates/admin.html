<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if permissions.has_admin_access %}管理面板{% else %}用户面板{% endif %}</title>
    <link rel="stylesheet" href="/static/{{ theme }}/css/style.css" id="theme-link">
    <link rel="stylesheet" href="/static/{{ theme }}/css/admin_panel.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>{% if permissions.has_admin_access %}管理面板{% else %}用户面板{% endif %}</h1>
            <div class="header-buttons">
                <select id="theme-selector" class="btn-secondary">
                    <option value="default">默认主题</option>
                    <option value="wooden">木质主题</option>
                </select>
                <button id="admin-menu-btn" class="btn-secondary">菜单</button>
            </div>
        </header>
        
        <!-- 抽屉式菜单 -->
        <div id="admin-drawer" class="drawer">
            <div class="drawer-header">
                <h2>导航菜单</h2>
                <button id="close-drawer-btn" class="btn-secondary">关闭</button>
            </div>
            <div class="drawer-content">
                <ul>
                    <li><a href="/">返回首页</a></li>
                    <li><a href="/dashboard">{% if permissions.has_admin_access %}管理面板{% else %}用户面板{% endif %}</a></li>
                    {% if permissions.has_admin_access %}
                    <li><a href="/admin/role-permission">角色权限管理</a></li>
                    {% endif %}
                    <li><a href="/redoc" target="_blank">API 文档</a></li>
                    <li><a href="/logout">登出</a></li>
                </ul>
            </div>
        </div>
        
        <div id="drawer-overlay" class="drawer-overlay"></div>
        
        <div class="admin-container">
            <!-- 用户信息显示 -->
            {% if username %}
            <div class="section">
                <h2>用户信息</h2>
                <p>当前用户: <strong>{{ username }}</strong></p>
                <p>权限级别: <strong>{% if permissions.has_super_admin %}超级管理员{% elif permissions.has_admin_access %}管理员{% else %}普通用户{% endif %}</strong></p>
            </div>
            {% endif %}
            
            <!-- 章节顺序配置 - 需要内容编辑权限 -->
            {% if permissions.has_content_edit %}
            <div class="section">
                <h2>章节顺序配置</h2>
                <div class="form-group">
                    <label>章节顺序</label>
                    <ul id="chapters" class="chapter-list">
                        <!-- 章节将通过JavaScript动态添加 -->
                    </ul>
                </div>
                <div class="btn-group">
                    <button type="button" id="save-chapters-btn" class="btn-primary">保存章节顺序</button>
                    <button type="button" id="reset-chapters-btn" class="btn-secondary">重置</button>
                </div>
            </div>
            {% endif %}
            
            <!-- 图书生成 - 需要构建权限 -->
            {% if permissions.has_build_epub or permissions.has_build_pdf %}
            <div class="section">
                <h2>图书生成</h2>
                <div class="btn-group">
                    {% if permissions.has_build_epub and permissions.has_build_pdf %}
                    <button type="button" id="build-all-btn" class="btn-primary">生成所有格式 (EPUB & PDF)</button>
                    {% endif %}
                    {% if permissions.has_build_epub %}
                    <button type="button" id="build-epub-btn" class="btn-secondary">生成 EPUB 格式</button>
                    {% endif %}
                    {% if permissions.has_build_pdf %}
                    <button type="button" id="build-pdf-btn" class="btn-secondary">生成 PDF 格式</button>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            
            <!-- Src目录管理 - 需要系统配置权限 -->
            {% if permissions.has_system_config %}
            <div class="section">
                <h2>Src目录管理</h2>
                <div class="form-group">
                    <label for="src-upload">上传Src目录Zip包:</label>
                    <input type="file" id="src-upload" accept=".zip" />
                    <button type="button" id="upload-src-btn" class="btn-primary">上传</button>
                </div>
                <div class="btn-group">
                    <button type="button" id="download-src-btn" class="btn-secondary">下载Src目录</button>
                    <button type="button" id="reset-src-btn" class="btn-danger">重置Src目录</button>
                </div>
            </div>
            {% endif %}
            
            <!-- EPUB转换 - 需要EPUB转换权限 -->
            {% if permissions.has_epub_conversion %}
            <div class="section" id="epub-conversion-section">
                <h2>EPUB转换</h2>
                <div class="form-group">
                    <label for="epub-upload">上传EPUB文件:</label>
                    <input type="file" id="epub-upload" accept=".epub" />
                    <button type="button" id="convert-epub-btn" class="btn-primary">转换为Markdown</button>
                </div>
                <div id="conversion-result" class="hidden">
                    <p>转换完成！</p>
                    <button type="button" id="download-converted-btn" class="btn-secondary">下载转换结果</button>
                </div>
            </div>
            {% endif %}
            
            <!-- 手动备份 - 需要手动备份权限 -->
            {% if permissions.has_manual_backup %}
            <div class="section" id="manual-backup-section">
                <h2>手动备份</h2>
                <div class="btn-group">
                    <button type="button" id="manual-backup-btn" class="btn-primary">手动备份Src目录</button>
                </div>
            </div>
            
            <!-- 备份文件管理 -->
            <div class="section">
                <h2>备份文件管理</h2>
                <div id="backup-files-container">
                    <p>正在加载备份文件列表...</p>
                </div>
            </div>
            {% endif %}
             
             <!-- 权限管理 - 需要管理员权限 -->
             {% if permissions.has_admin_access %}
             <div class="section" id="permission-management-section">
                 <h2>权限管理</h2>
                 <div class="btn-group">
                     <button type="button" id="check-permissions-btn" class="btn-primary">检查权限</button>
                 </div>
                 <div id="permissions-container">
                     <p>正在加载权限信息...</p>
                 </div>
             </div>
             {% endif %}
             
             <!-- 如果用户没有任何特殊权限，显示提示信息 -->
             {% if not (permissions.has_content_edit or permissions.has_build_epub or permissions.has_build_pdf or permissions.has_system_config or permissions.has_epub_conversion or permissions.has_manual_backup or permissions.has_admin_access) %}
             <div class="section">
                 <h2>欢迎</h2>
                 <p>您当前没有特殊的操作权限。如需要更多功能，请联系管理员为您分配相应的权限。</p>
                 <p>您可以通过左上角的菜单访问其他功能，或者<a href="/">返回首页</a>进行文件编辑。</p>
             </div>
             {% endif %}
        </div>
    </div>
    
    <!-- 引入公共JavaScript函数库 -->
    <script src="/static/common/js/common.js"></script>
    <script src="/static/common/js/admin-common.js"></script>
    <script src="/static/common/js/main-shared.js"></script>
    <script src="/static/{{ theme }}/js/admin_panel.js"></script>
    
    <!-- 将权限信息传递给JavaScript -->
    <script>
        window.userPermissions = {{ user_permissions | tojson }};
        window.permissionFlags = {{ permissions | tojson }};
    </script>
</body>
</html>