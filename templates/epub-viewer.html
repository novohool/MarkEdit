<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPUB.js</title>

    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs@0.3.93/dist/epub.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }

        #viewer {
            margin: 20px auto;
            max-width: 800px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            background-color: white;
        }

        #toc {
            display: block;
            margin: 20px auto;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
            max-width: 800px;
        }

        .arrow {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            font-size: 36px;
            color: #333;
            text-decoration: none;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }

        #prev {
            left: 20px;
        }

        #next {
            right: 20px;
        }

        .arrow:hover {
            background-color: rgba(200, 200, 200, 0.8);
        }

        .spreads {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .single {
            display: block;
            margin: 0 auto;
        }
    </style>
</head>
<body>
  <!-- <div id="title"></div> -->
  <select id="toc"></select>
  <div id="viewer" class="spreads"></div>
  <a id="prev" href="#prev" class="arrow">‹</a>
  <a id="next" href="#next" class="arrow">›</a>

    <script>
        var params = URLSearchParams && new URLSearchParams(document.location.search.substring(1));
        var url = params && params.get("url") && decodeURIComponent(params.get("url"));
        var currentSectionIndex = (params && params.get("loc")) ? params.get("loc") : undefined;

        // Load the opf
        var book = ePub(url);
        var rendition = book.renderTo("viewer", {
            width: "100%",
            height: 600,
            spread: "always",
            method: "write"
        });

        rendition.display(currentSectionIndex);

        book.ready.then(function() {

            var next = document.getElementById("next");

            next.addEventListener("click", function(e){
                book.package.metadata.direction === "rtl" ? rendition.prev() : rendition.next();
                e.preventDefault();
            }, false);

            var prev = document.getElementById("prev");
            prev.addEventListener("click", function(e){
                book.package.metadata.direction === "rtl" ? rendition.next() : rendition.prev();
                e.preventDefault();
            }, false);

            var keyListener = function(e){

                // Left Key
                if ((e.keyCode || e.which) == 37) {
                    book.package.metadata.direction === "rtl" ? rendition.next() : rendition.prev();
                }

                // Right Key
                if ((e.keyCode || e.which) == 39) {
                    book.package.metadata.direction === "rtl" ? rendition.prev() : rendition.next();
                }

            };

            rendition.on("keyup", keyListener);
            document.addEventListener("keyup", keyListener, false);

        })

        var title = document.getElementById("title");

        rendition.on("rendered", function(section){
            var current = book.navigation && book.navigation.get(section.href);

            if (current) {
                var $select = document.getElementById("toc");
                var $selected = $select.querySelector("option[selected]");
                if ($selected) {
                    $selected.removeAttribute("selected");
                }

                var $options = $select.querySelectorAll("option");
                for (var i = 0; i < $options.length; ++i) {
                    let selected = $options[i].getAttribute("ref") === current.href;
                    if (selected) {
                        $options[i].setAttribute("selected", "");
                    }
                }
            }

        });

        rendition.on("relocated", function(location){
            console.log(location);

            var next = book.package.metadata.direction === "rtl" ?  document.getElementById("prev") : document.getElementById("next");
            var prev = book.package.metadata.direction === "rtl" ?  document.getElementById("next") : document.getElementById("prev");

            if (location.atEnd) {
                next.style.visibility = "hidden";
            } else {
                next.style.visibility = "visible";
            }

            if (location.atStart) {
                prev.style.visibility = "hidden";
            } else {
                prev.style.visibility = "visible";
            }

        });

        rendition.on("layout", function(layout) {
            let viewer = document.getElementById("viewer");

            if (layout.spread) {
                viewer.classList.remove('single');
            } else {
                viewer.classList.add('single');
            }
        });

        // 使用pagehide事件替代unload事件，避免权限策略违规
        window.addEventListener("pagehide", function () {
            console.log("page hiding");
            if (this.book) {
                this.book.destroy();
            }
        });

        book.loaded.navigation.then(function(toc){
            var $select = document.getElementById("toc"),
                    docfrag = document.createDocumentFragment();

            toc.forEach(function(chapter) {
                var option = document.createElement("option");
                option.textContent = chapter.label;
                option.setAttribute("ref", chapter.href);

                docfrag.appendChild(option);
            });

            $select.appendChild(docfrag);

            $select.onchange = function(){
                var index = $select.selectedIndex,
                        url = $select.options[index].getAttribute("ref");
                rendition.display(url);
                return false;
            };

        });
    </script>
</body>
</html>