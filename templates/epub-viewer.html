<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPUB Viewer</title>
    <!-- 引入EPUB.js库 -->
    <script src="https://cdn.jsdelivr.net/npm/epubjs@0.3.93/dist/epub.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
        }
        
        #epub-viewer {
            width: 100%;
            height: 100vh;
            border: none;
        }
        
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
            color: #333;
        }
        
        #error {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
            color: #d32f2f;
            text-align: center;
            display: none;
        }
    </style>
</head>
<body>
    <div id="loading">正在加载EPUB文件...</div>
    <div id="error">
        <p>无法加载EPUB文件</p>
        <button onclick="retryLoad()">重试</button>
    </div>
    <div id="epub-viewer"></div>

    <script>
        // 从URL参数获取EPUB文件路径
        const urlParams = new URLSearchParams(window.location.search);
        const epubFile = urlParams.get('file');
        
        if (!epubFile) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error').innerHTML = '<p>未指定EPUB文件路径</p>';
        } else {
            // 加载EPUB文件
            loadEpub(epubFile);
        }
        
        function loadEpub(filePath) {
            try {
                console.log('正在加载EPUB文件:', filePath);
                
                // 创建EPUB阅读器
                const book = ePub(filePath);
                const rendition = book.renderTo("epub-viewer", {
                    width: "100%",
                    height: "100%",
                    spread: "none"  // 禁用双页 spread
                });
                
                // 显示第一章节
                book.loaded.navigation.then(function(toc) {
                    console.log('EPUB目录加载成功:', toc);
                    document.getElementById('loading').style.display = 'none';
                    
                    if (toc && toc[0]) {
                        console.log('显示目录中的第一章节:', toc[0].href);
                        rendition.display(toc[0].href);
                    } else {
                        // 如果没有目录，尝试显示第一个章节
                        console.log('没有目录，尝试显示第一个章节');
                        book.spine.first().then(function(section) {
                            console.log('显示第一个章节:', section.href);
                            rendition.display(section.href);
                        }).catch(function(error) {
                            console.error('显示第一个章节失败:', error);
                            showError();
                        });
                    }
                }).catch(function(error) {
                    console.error('加载EPUB目录失败:', error);
                    showError();
                });
                
                // 添加章节渲染错误处理
                rendition.on('rendered', function(section) {
                    console.log('章节渲染成功:', section.href);
                });
                
                rendition.on('displayed', function(section) {
                    console.log('章节显示成功:', section.href);
                });
                
                rendition.on('relocated', function(location) {
                    console.log('位置变更:', location);
                });
            } catch (error) {
                console.error('加载EPUB文件失败:', error);
                showError();
            }
        }
        
        function showError() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
        }
        
        // 页面加载完成后添加更多调试信息
        window.addEventListener('DOMContentLoaded', function() {
            console.log('EPUB查看器页面已加载');
            console.log('当前URL参数:', window.location.search);
        });
        
        function retryLoad() {
            document.getElementById('error').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            loadEpub(epubFile);
        }
    </script>
</body>
</html>